<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compras – RG NIXKAB</title>

  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/sweetalert2.css" />
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css" />
  <link rel="stylesheet" href="css/main.css" />

  <!-- Scripts base -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- NavBar -->
  <div class="full-width navBar">
    <div class="full-width navBar-options">
      <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>
      <div class="mdl-tooltip" for="btn-menu">Menú</div>
      <nav class="navBar-options-list">
        <ul class="list-unstyle">
          <li class="btn-exit" onclick="logout()">
            <i class="zmdi zmdi-power"></i>
            <div class="mdl-tooltip" for="btn-exit">Cerrar sesión</div>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Lateral -->
  <section class="full-width navLateral">
    <div class="full-width navLateral-bg btn-menu"></div>
    <div class="full-width navLateral-body">
      <div class="full-width navLateral-body-logo text-center tittles">
        <i class="zmdi zmdi-close btn-menu"></i> DISTRIBUIDORA RG - NIXKAB
      </div>
      <figure class="full-width" style="height: 77px;">
        <div class="navLateral-body-cl">
          <img src="assets/img/logo_rg.png" alt="Avatar" class="img-responsive" />
        </div>
        <figcaption class="navLateral-body-cr hide-on-tablet">
          <span><br /><small></small></span>
        </figcaption>
      </figure>
      <div class="full-width tittles navLateral-body-tittle-menu">
        <i class="zmdi zmdi-desktop-mac"></i><span class="hide-on-tablet"> MENÚ</span>
      </div>
      <nav class="full-width">
        <ul class="full-width list-unstyle menu-principal">
          <li><a href="home_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-view-dashboard"></i></div><div class="navLateral-body-cr hide-on-tablet">Inicio</div></a></li>
          <li><a href="inventario_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-store"></i></div><div class="navLateral-body-cr hide-on-tablet">Inventario</div></a></li>
          <li><a href="cliente_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-accounts"></i></div><div class="navLateral-body-cr hide-on-tablet">Clientes</div></a></li>
          <li><a href="compras_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-basket"></i></div><div class="navLateral-body-cr hide-on-tablet">Compras</div></a></li>
          <li><a href="proveedores_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-truck"></i></div><div class="navLateral-body-cr hide-on-tablet">Proveedores</div></a></li>
          <li><a href="ventas_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div><div class="navLateral-body-cr hide-on-tablet">Ventas</div></a></li>
          <li><a href="cuentas-cobrar_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-balance-wallet"></i></div><div class="navLateral-body-cr hide-on-tablet">Cuentas por cobrar</div></a></li>
          <li><a href="generar_xls_nixkab.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-file"></i></div><div class="navLateral-body-cr hide-on-tablet">Generar XLS</div></a></li>
        </ul>
      </nav>
    </div>
  </section>

  <!-- Contenido -->
  <section class="full-width pageContent">
    <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
      <div class="mdl-tabs__tab-bar">
        <a href="#tabNewCompra" class="mdl-tabs__tab is-active">Registrar compra</a>
        <a href="#tabListCompras" class="mdl-tabs__tab">Historial de compras</a>
      </div>

      <!-- Registrar compra (con carrito) -->
      <div class="mdl-tabs__panel is-active" id="tabNewCompra">
        <div class="mdl-grid">
          <div class="mdl-cell mdl-cell--8-col mdl-cell--2-offset-desktop">
            <div class="full-width panel mdl-shadow--2dp">
              <div class="full-width panel-tittle bg-primary text-center tittles">Registrar nueva compra (con carrito)</div>
              <div class="full-width panel-content">
                <form id="form-compra">
                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input type="text" class="mdl-textfield__input" id="compraFactura" />
                    <label class="mdl-textfield__label" for="compraFactura">No. de factura</label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="compraProveedor" />
                    <label class="mdl-textfield__label" for="compraProveedor">Proveedor</label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <select class="mdl-textfield__input" id="compraProducto">
                      <option value="">Selecciona un producto</option>
                    </select>
                    <label class="mdl-textfield__label" for="compraProducto"></label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="number" step="0.01" id="productQty" />
                    <label class="mdl-textfield__label" for="productQty">Cantidad</label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input type="number" class="mdl-textfield__input" id="compraPrecio" step="0.01" />
                    <label class="mdl-textfield__label" for="compraPrecio">Precio unitario</label>
                  </div>

                  <p class="text-center">
                    <button id="btn-addCarrito" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                      Agregar al carrito
                    </button>
                  </p>
                </form>

                <!-- Carrito -->
                <div class="mdl-cell mdl-cell--12-col">
                  <h5 class="text-center">Carrito de Compras</h5>
                  <table class="mdl-data-table mdl-js-data-table full-width" id="tablaCarrito">
                    <thead>
                      <tr>
                        <th>Producto</th>
                        <th class="text-center">Cantidad</th>
                        <th class="text-center">Precio unitario</th>
                        <th class="text-center">Subtotal</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                      <tr>
                        <td colspan="3"><strong>Total compra</strong></td>
                        <td id="compraTotal">Q0.00</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <p class="text-center">
                  <button id="btn-finalizarCompra" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    Finalizar compra
                  </button>
                </p>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Historial de compras -->
      <div class="mdl-tabs__panel" id="tabListCompras">
        <div class="mdl-grid">
          <div class="mdl-cell mdl-cell--10-col mdl-cell--1-offset-desktop">
            <div class="full-width panel mdl-shadow--2dp">
              <div class="full-width panel-tittle bg-success text-center tittles">Historial de compras</div>
              <div class="full-width panel-content">
                <div class="mdl-list" id="compra-list"></div>
                <div style="text-align:right; margin:10px 0;">
                  <input type="text" id="filtroCompras" placeholder="Buscar por proveedor, factura o producto..." class="mdl-textfield__input" style="width:50%;" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <p class="text-center">
          <button id="btn-pdf-compras" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
            <i class="zmdi zmdi-print"></i> Imprimir historial de compras
          </button>
        </p>
      </div>
    </div>
  </section>

  <!-- SCRIPT con carrito -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, set, get, update, push, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    // Fallback de bitácora
    window.registrarAccion = window.registrarAccion || (async () => {});

    const firebaseConfig = {
      apiKey: "AIzaSyB3V7b4lnqv8gTZa-HnczZhghSlYr1jHjE",
      authDomain: "distribuidorarg-9951a.firebaseapp.com",
      databaseURL: "https://distribuidorarg-9951a-default-rtdb.firebaseio.com",
      projectId: "distribuidorarg-9951a",
      storageBucket: "distribuidorarg-9951a.firebasestorage.app",
      messagingSenderId: "785071843932",
      appId: "1:785071843932:web:59832bb2161f30ed665499"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Estado
    let carrito = []; // {codigo, nombre, cantidad, precio}
    let productosCache = {}; // codigo -> producto

    // Refs UI
    const selectProducto = document.getElementById("compraProducto");
    const qtyInput = document.getElementById("productQty");
    const precioInput = document.getElementById("compraPrecio");
    const tablaCarritoBody = document.querySelector("#tablaCarrito tbody");
    const totalDisplay = document.getElementById("compraTotal");
    const listaHistorial = document.getElementById("compra-list");

    // Cargar productos y cache
    get(ref(db, "productos_nixkab"))
      .then((snapshot) => {
        const productos = snapshot.val();
        if (!productos) return;

        Object.values(productos).forEach((prod) => {
          const codigo = prod.codigo || "";
          const nombre = prod.nombre || "";
          productosCache[codigo] = { ...prod, codigo, nombre };

          const option = document.createElement("option");
          option.value = codigo;
          option.textContent = `${codigo || "—"} – ${nombre}`;
          selectProducto.appendChild(option);
        });
      })
      .catch((err) => {
        console.error("Error cargando productos:", err);
        Swal.fire("Error", "No se pudieron cargar los productos", "error");
      });

    // Agregar al carrito
    document.getElementById("btn-addCarrito").addEventListener("click", (e) => {
      e.preventDefault();

      const codigo = selectProducto.value;
      const cantidad = Number((qtyInput.value || "").trim());
      const precio = Number((precioInput.value || "").trim());

      if (!codigo || !cantidad || cantidad <= 0 || !precio || precio <= 0) {
        Swal.fire("Campos requeridos", "Selecciona un producto y coloca cantidad y precio válidos", "warning");
        return;
      }
      const prod = productosCache[codigo];
      if (!prod) {
        Swal.fire("Producto no encontrado", "Actualiza la página e intenta de nuevo", "error");
        return;
      }

      const existente = carrito.find((p) => p.codigo === codigo);
      if (existente) {
        existente.cantidad += cantidad;
        existente.precio = precio; // actualizamos al último precio ingresado
      } else {
        carrito.push({ codigo, nombre: prod.nombre || codigo, cantidad, precio });
      }

      qtyInput.value = "";
      precioInput.value = "";
      selectProducto.selectedIndex = 0;
      levantarLabels(["productQty", "compraPrecio"]);

      renderizarCarrito();
    });

    function renderizarCarrito() {
      tablaCarritoBody.innerHTML = "";
      let total = 0;

      carrito.forEach((item, i) => {
        const subtotal = Number(item.cantidad) * Number(item.precio);
        total += subtotal;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.nombre} <small style="opacity:.7">(${item.codigo})</small></td>
          <td class="text-center">${item.cantidad}</td>
          <td class="text-center">Q${Number(item.precio).toFixed(2)}</td>
          <td class="text-center">Q${subtotal.toFixed(2)}</td>
          <td class="text-center">
            <button class="mdl-button mdl-js-button mdl-button--icon" title="Quitar" onclick="eliminarDelCarrito(${i})">
              <i class="zmdi zmdi-close"></i>
            </button>
          </td>
        `;
        tablaCarritoBody.appendChild(tr);
      });

      totalDisplay.textContent = "Q" + total.toFixed(2);
    }

    window.eliminarDelCarrito = function(i) {
      carrito.splice(i, 1);
      renderizarCarrito();
    };

    // Finalizar compra (una compra con varios items)
    document.getElementById("btn-finalizarCompra").addEventListener("click", async () => {
      const proveedor = document.getElementById("compraProveedor").value.trim();
      const factura = document.getElementById("compraFactura").value.trim();

      if (!proveedor) {
        Swal.fire("Proveedor requerido", "Indica el proveedor de la factura", "warning");
        return;
      }
      if (carrito.length === 0) {
        Swal.fire("Carrito vacío", "Agrega al menos un producto", "warning");
        return;
      }

      const fecha = new Date().toISOString().split("T")[0];
      const total = carrito.reduce((t, p) => t + (Number(p.precio) * Number(p.cantidad)), 0);

      const compra = {
        factura: factura || "-",
        proveedor,
        fecha,
        total: total.toFixed(2),
        items: carrito.map((p) => ({
          codigo: p.codigo,
          nombre: p.nombre,
          cantidad: Number(p.cantidad),
          precioUnitario: Number(p.precio)
        }))
      };

      try {
        // Guardar compra
        const nuevaRef = await push(ref(db, "compras_nixkab"), compra);

        // Actualizar stock (sumar) por cada item
        await Promise.all(compra.items.map(async (p) => {
          const prodRef = ref(db, "productos_nixkab/" + p.codigo);
          const snap = await get(prodRef);
          const actual = snap.val();
          const nuevoStock = (Number(actual?.cantidad) || 0) + Number(p.cantidad);
          return update(prodRef, { cantidad: nuevoStock });
        }));

        registrarAccion("registró una compra", "compras_nixkab", {
          proveedor: compra.proveedor,
          factura: compra.factura,
          total: compra.total,
          productos: compra.items.map((p) => `${p.nombre} x ${p.cantidad}`),
          compraId: nuevaRef.key
        });

        carrito = [];
        renderizarCarrito();
        document.getElementById("form-compra").reset();
        Swal.fire("Compra registrada", "Stock actualizado correctamente", "success");
      } catch (err) {
        console.error(err);
        Swal.fire("Error", "No se pudo registrar la compra", "error");
      }
    });

    // Historial en vivo
    onValue(ref(db, "compras_nixkab"), (snapshot) => {
      listaHistorial.innerHTML = "";
      const data = snapshot.val();
      if (!data) return;

      const entradas = Object.entries(data).sort((a, b) => (b[1].fecha || "").localeCompare(a[1].fecha || ""));

      entradas.forEach(([id, c]) => {
        const resumen = Array.isArray(c.items)
          ? c.items.map(it => `${it.nombre || it.codigo} (${it.cantidad})`).join(", ")
          : `${c.codigoProducto || "-"} (${c.cantidad || "-"})`;

        const item = document.createElement("div");
        item.className = "mdl-list__item mdl-list__item--three-line";
        item.innerHTML = `
          <span class="mdl-list__item-primary-content">
            <i class="zmdi zmdi-truck mdl-list__item-avatar"></i>
            <span><strong>${c.proveedor || "-"}</strong> – Factura: ${c.factura || "-"}</span>
            <span class="mdl-list__item-sub-title">${c.fecha || "-"} | ${resumen} | Total: Q${Number(c.total || 0).toFixed(2)}</span>
          </span>
          <span class="mdl-list__item-secondary-action">
            <button class="mdl-button mdl-js-button mdl-button--icon" title="Imprimir" onclick="imprimirCompra('${id}')">
              <i class="zmdi zmdi-print"></i>
            </button>
            <button class="mdl-button mdl-js-button mdl-button--icon" title="Eliminar" onclick="eliminarCompra('${id}')">
              <i class="zmdi zmdi-delete"></i>
            </button>
          </span>
        `;
        listaHistorial.appendChild(item);
      });
    });

    // Filtro
    document.getElementById("filtroCompras").addEventListener("input", (e) => {
      const filtro = e.target.value.toLowerCase();
      document.querySelectorAll("#compra-list .mdl-list__item").forEach((item) => {
        item.style.display = item.textContent.toLowerCase().includes(filtro) ? "block" : "none";
      });
    });

    // PDF del historial
    document.getElementById("btn-pdf-compras").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("HISTORIAL DE COMPRAS – DISTRIBUIDORA RG NIXKAB", 20, 20);
      doc.setFontSize(10);
      doc.text("Fecha: " + new Date().toLocaleDateString(), 20, 28);

      const snap = await get(ref(db, "compras_nixkab"));
      const data = snap.val();
      if (!data) {
        Swal.fire("Nada para imprimir", "No hay compras registradas", "info");
        return;
      }

      const rows = Object.values(data).map((c) => {
        const resumen = Array.isArray(c.items)
          ? c.items.map(i => `${i.nombre || i.codigo} (${i.cantidad})`).join(", ")
          : (c.codigoProducto || "-") + " (" + (c.cantidad || "-") + ")";
        return [c.factura || "-", c.proveedor || "-", c.fecha || "-", resumen, "Q" + Number(c.total || 0).toFixed(2)];
      });

      doc.autoTable({
        head: [["Factura", "Proveedor", "Fecha", "Productos", "Total"]],
        body: rows,
        startY: 35,
        theme: "striped"
      });

      doc.save("compras_distribuidora_rg_nixkab.pdf");
    });

    // Imprimir una compra
    window.imprimirCompra = async function(id) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const s = await get(ref(db, "compras_nixkab/" + id));
      const c = s.val();
      if (!c) return;

      doc.setFontSize(16);
      doc.text("NOTA DE COMPRA – DISTRIBUIDORA RG NIXKAB", 20, 20);
      doc.setFontSize(10);
      doc.text(`Proveedor: ${c.proveedor || "-"}`, 20, 28);
      doc.text(`Factura: ${c.factura || "-"}`, 20, 33);
      doc.text(`Fecha: ${c.fecha || "-"}`, 20, 38);

      const items = Array.isArray(c.items) ? c.items : [{
        codigo: c.codigoProducto || "-",
        nombre: c.codigoProducto || "-",
        cantidad: Number(c.cantidad || 0),
        precioUnitario: Number(c.precioUnitario || 0)
      }];

      const body = items.map(i => [
        i.codigo || "-",
        i.nombre || "-",
        i.cantidad,
        "Q" + Number(i.precioUnitario || 0).toFixed(2),
        "Q" + (Number(i.cantidad || 0) * Number(i.precioUnitario || 0)).toFixed(2)
      ]);

      doc.autoTable({
        head: [["Código", "Producto", "Cantidad", "Precio U.", "Subtotal"]],
        body,
        startY: 45,
        theme: "grid"
      });

      const y = doc.lastAutoTable.finalY + 8;
      doc.setFontSize(12);
      doc.text("Total: Q" + Number(c.total || 0).toFixed(2), 20, y);

      doc.save(`compra_${c.factura || id}.pdf`);
    };

    // Eliminar compra (revierte stock)
    window.eliminarCompra = function(id) {
      Swal.fire({
        title: "¿Eliminar compra?",
        text: "Se revertirá el stock de sus productos.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, eliminar"
      }).then(async (r) => {
        if (!r.isConfirmed) return;

        const s = await get(ref(db, "compras_nixkab/" + id));
        const c = s.val();
        if (!c) return;

        const items = Array.isArray(c.items) ? c.items : [{
          codigo: c.codigoProducto,
          cantidad: Number(c.cantidad || 0)
        }];

        try {
          await Promise.all(items.map(async (it) => {
            if (!it || !it.codigo) return;
            const prodRef = ref(db, "productos_nixkab/" + it.codigo);
            const snap = await get(prodRef);
            const actual = snap.val();
            const nuevoStock = Math.max(0, (Number(actual?.cantidad) || 0) - Number(it.cantidad || 0));
            return update(prodRef, { cantidad: nuevoStock });
          }));

          await set(ref(db, "compras_nixkab/" + id), null);

          registrarAccion("eliminó una compra", "compras_nixkab", {
            proveedor: c.proveedor,
            factura: c.factura || "-",
            total: c.total,
            productos: (c.items || []).map(p => `${p.nombre || p.codigo} (${p.cantidad})`),
            fecha: c.fecha
          });

          Swal.fire("Eliminado", "Compra eliminada y stock revertido", "success");
        } catch (err) {
          console.error(err);
          Swal.fire("Error", "No se pudo eliminar o revertir el stock", "error");
        }
      });
    };

    // Helpers
    function levantarLabels(ids) {
      ids.forEach((id) => {
        const el = document.getElementById(id);
        const wrap = el ? el.closest(".mdl-textfield") : null;
        if (wrap) wrap.classList.add("is-dirty");
      });
    }

    // Logout
    function logout() {
      signOut(auth)
        .then(() => window.location.href = "opciones.html")
        .catch(() => Swal.fire("Error", "No se pudo cerrar sesión", "error"));
    }
    window.logout = logout;
  </script>
</body>
</html>
