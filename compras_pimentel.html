<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compras – RG PIMENTEL</title>

  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/sweetalert2.css" />
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css" />
  <link rel="stylesheet" href="css/main.css" />

  <!-- Scripts base -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- NavBar -->
  <div class="full-width navBar">
    <div class="full-width navBar-options">
      <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>
      <div class="mdl-tooltip" for="btn-menu">Menú</div>
      <nav class="navBar-options-list">
        <ul class="list-unstyle">
          <li class="btn-exit" onclick="logout()">
            <i class="zmdi zmdi-power"></i>
            <div class="mdl-tooltip" for="btn-exit">Cerrar sesión</div>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Lateral -->
  <section class="full-width navLateral">
    <div class="full-width navLateral-bg btn-menu"></div>
    <div class="full-width navLateral-body">
      <div class="full-width navLateral-body-logo text-center tittles">
        <i class="zmdi zmdi-close btn-menu"></i> DISTRIBUIDORA RG - PIMENTEL
      </div>
      <figure class="full-width" style="height: 77px;">
        <div class="navLateral-body-cl">
          <img src="assets/img/logo_rg.png" alt="Avatar" class="img-responsive" />
        </div>
        <figcaption class="navLateral-body-cr hide-on-tablet">
          <span><br /><small></small></span>
        </figcaption>
      </figure>
      <div class="full-width tittles navLateral-body-tittle-menu">
        <i class="zmdi zmdi-desktop-mac"></i><span class="hide-on-tablet"> MENÚ</span>
      </div>
      <nav class="full-width">
        <ul class="full-width list-unstyle menu-principal">
          <li><a href="home_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-view-dashboard"></i></div><div class="navLateral-body-cr hide-on-tablet">Inicio</div></a></li>
          <li><a href="inventario_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-store"></i></div><div class="navLateral-body-cr hide-on-tablet">Inventario</div></a></li>
          <li><a href="cliente_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-accounts"></i></div><div class="navLateral-body-cr hide-on-tablet">Clientes</div></a></li>
          <li><a href="compras_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-basket"></i></div><div class="navLateral-body-cr hide-on-tablet">Compras</div></a></li>
          <li><a href="proveedores_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-truck"></i></div><div class="navLateral-body-cr hide-on-tablet">Proveedores</div></a></li>
          <li><a href="ventas_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div><div class="navLateral-body-cr hide-on-tablet">Ventas</div></a></li>
          <li><a href="cuentas-cobrar_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-balance-wallet"></i></div><div class="navLateral-body-cr hide-on-tablet">Cuentas por cobrar</div></a></li>
          <li><a href="generar_xls_pimentel.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-file"></i></div><div class="navLateral-body-cr hide-on-tablet">Generar XLS</div></a></li>
        </ul>
      </nav>
    </div>
  </section>

  <!-- Contenido -->
  <section class="full-width pageContent">
    <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
      <div class="mdl-tabs__tab-bar">
        <a href="#tabNewCompra" class="mdl-tabs__tab is-active">Registrar compra</a>
        <a href="#tabListCompras" class="mdl-tabs__tab">Historial de compras</a>
      </div>

      <!-- Registrar compra -->
      <div class="mdl-tabs__panel is-active" id="tabNewCompra">
        <div class="mdl-grid">
          <div class="mdl-cell mdl-cell--6-col mdl-cell--3-offset-desktop">
            <div class="full-width panel mdl-shadow--2dp">
              <div class="full-width panel-tittle bg-primary text-center tittles">Registrar nueva compra</div>
              <div class="full-width panel-content">
                <form id="form-compra">
                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input type="text" class="mdl-textfield__input" id="compraFactura" />
                    <label class="mdl-textfield__label" for="compraFactura">No. de factura</label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="compraProveedor" />
                    <label class="mdl-textfield__label" for="compraProveedor">Proveedor</label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <select class="mdl-textfield__input" id="compraProducto">
                      <option value="">Selecciona un producto</option>
                    </select>
                    <label class="mdl-textfield__label" for="compraProducto"></label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="number" step="0.01" id="productQty" />
                    <label class="mdl-textfield__label" for="productQty">Cantidad</label>
                  </div>

                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input type="number" class="mdl-textfield__input" id="compraPrecio" step="0.01" />
                    <label class="mdl-textfield__label" for="compraPrecio">Precio unitario</label>
                  </div>

                  <p class="text-center">
                    <button id="btn-addCompra" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored">
                      Registrar compra
                    </button>
                  </p>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Historial de compras -->
      <div class="mdl-tabs__panel" id="tabListCompras">
        <div class="mdl-grid">
          <div class="mdl-cell mdl-cell--10-col mdl-cell--1-offset-desktop">
            <div class="full-width panel mdl-shadow--2dp">
              <div class="full-width panel-tittle bg-success text-center tittles">Historial de compras</div>
              <div class="full-width panel-content">
                <div class="mdl-list" id="compra-list"></div>

                <div style="text-align:right; margin-bottom:10px;">
                  <input type="text" id="filtroCompras" placeholder="Buscar por proveedor o producto..." class="mdl-textfield__input" style="width:50%;" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <p class="text-center">
          <button id="btn-pdf-compras" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
            <i class="zmdi zmdi-print"></i> Imprimir historial de compras
          </button>
        </p>
      </div>
    </div>
  </section>

  <!-- SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, set, get, update, push, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    // Fallback por si registrarAccion no está definido en otro archivo
    window.registrarAccion = window.registrarAccion || (async () => {});

    const firebaseConfig = {
      apiKey: "AIzaSyB3V7b4lnqv8gTZa-HnczZhghSlYr1jHjE",
      authDomain: "distribuidorarg-9951a.firebaseapp.com",
      databaseURL: "https://distribuidorarg-9951a-default-rtdb.firebaseio.com",
      projectId: "distribuidorarg-9951a",
      storageBucket: "distribuidorarg-9951a.firebasestorage.app",
      messagingSenderId: "785071843932",
      appId: "1:785071843932:web:59832bb2161f30ed665499"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let compraEditando = null;

    // Cargar productos al <select>
    const selectProducto = document.getElementById("compraProducto");
    get(ref(db, "productos_pimentel"))
      .then((snapshot) => {
        const productos = snapshot.val();
        if (!productos) return;

        Object.values(productos).forEach((prod) => {
          const option = document.createElement("option");
          option.value = prod.codigo || "";
          option.textContent = `${prod.codigo || "—"} – ${prod.nombre || ""}`;
          selectProducto.appendChild(option);
        });
      })
      .catch((err) => {
        console.error("Error cargando productos:", err);
        Swal.fire("Error", "No se pudieron cargar los productos", "error");
      });

    // Registrar / Editar compra
    document.getElementById("btn-addCompra").addEventListener("click", (e) => {
      e.preventDefault();

      const proveedor = document.getElementById("compraProveedor").value.trim();
      const codigoProducto = document.getElementById("compraProducto").value;
      const cantidad = Number((document.getElementById("productQty").value || "").trim());
      const precioUnitario = Number((document.getElementById("compraPrecio").value || "").trim());
      const factura = document.getElementById("compraFactura").value.trim();

      if (!proveedor || !codigoProducto || !cantidad || !precioUnitario) {
        Swal.fire("Campos requeridos", "Debes completar todos los campos correctamente", "warning");
        return;
      }

      const fecha = new Date().toISOString().split("T")[0];
      const total = (cantidad * precioUnitario).toFixed(2);

      const compra = { proveedor, codigoProducto, cantidad, precioUnitario, total, fecha, factura };

      if (compraEditando) {
        // EDICIÓN: ajustar stock previo y nuevo
        get(ref(db, "compras_pimentel/" + compraEditando)).then((snapshot) => {
          const anterior = snapshot.val();
          if (!anterior) return;

          const refProdAnterior = ref(db, "productos_pimentel/" + anterior.codigoProducto);
          const refProdNuevo = ref(db, "productos_pimentel/" + compra.codigoProducto);

          // 1) Restar stock anterior
          get(refProdAnterior)
            .then((snapAnterior) => {
              const prodAntes = snapAnterior.val();
              const nuevoStockAnterior = (Number(prodAntes?.cantidad) || 0) - Number(anterior.cantidad);
              return update(refProdAnterior, { cantidad: nuevoStockAnterior });
            })
            // 2) Sumar stock nuevo
            .then(() =>
              get(refProdNuevo).then((snapNuevo) => {
                const prodNuevo = snapNuevo.val();
                const nuevoStock = (Number(prodNuevo?.cantidad) || 0) + Number(compra.cantidad);
                return update(refProdNuevo, { cantidad: nuevoStock });
              })
            )
            // 3) Guardar compra editada
            .then(() => set(ref(db, "compras_pimentel/" + compraEditando), compra))
            .then(() => {
              registrarAccion("editó una compra", "compras_pimentel", {
                ...compra,
                cambioDeProducto: anterior.codigoProducto !== compra.codigoProducto
              });
              Swal.fire("Compra actualizada", "Stock ajustado correctamente", "success");
              document.getElementById("form-compra").reset();
              selectProducto.selectedIndex = 0;
              compraEditando = null;
            })
            .catch((err) => {
              console.error(err);
              Swal.fire("Error", "No se pudo ajustar el stock", "error");
            });
        });
      } else {
        // NUEVA COMPRA
        push(ref(db, "compras_pimentel"), compra)
          .then(() => {
            registrarAccion("registró una compra", "compras_pimentel", {
              proveedor,
              producto: codigoProducto,
              cantidad,
              precioUnitario,
              total
            });

            const productoRef = ref(db, "productos_pimentel/" + codigoProducto);
            return get(productoRef).then((snap) => {
              const producto = snap.val();
              const nuevoStock = (Number(producto?.cantidad) || 0) + Number(cantidad);
              return update(productoRef, { cantidad: nuevoStock });
            });
          })
          .then(() => {
            Swal.fire("Compra registrada", `Stock actualizado (+${cantidad})`, "success");
            document.getElementById("form-compra").reset();
            selectProducto.selectedIndex = 0;
          })
          .catch((err) => {
            console.error(err);
            Swal.fire("Error", "No se pudo registrar la compra", "error");
          });

        compraEditando = null;
      }
    });

    // PDF de compras
    document.getElementById("btn-pdf-compras").addEventListener("click", () => {
      const doc = new window.jspdf.jsPDF();
      doc.setFontSize(16);
      doc.text("HISTORIAL DE COMPRAS – DISTRIBUIDORA RG PIMENTEL", 20, 20);
      doc.setFontSize(10);
      doc.text("Fecha: " + new Date().toLocaleDateString(), 20, 28);

      get(ref(db, "compras_pimentel")).then((snapshot) => {
        const data = snapshot.val();
        if (!data) {
          Swal.fire("Nada para imprimir", "No hay compras registradas", "info");
          return;
        }

        const rows = Object.values(data).map((c) => [
          c.factura || "-",
          c.proveedor || "-",
          c.codigoProducto || "-",
          c.fecha || "-",
          Number(c.cantidad || 0),
          "Q" + Number(c.precioUnitario || 0).toFixed(2),
          "Q" + (c.total ?? (Number(c.cantidad || 0) * Number(c.precioUnitario || 0)).toFixed(2))
        ]);

        doc.autoTable({
          head: [["Factura", "Proveedor", "Producto", "Fecha", "Cantidad", "Precio", "Total"]],
          body: rows,
          startY: 35,
          theme: "striped"
        });

        doc.save("compras_distribuidora_rg_pimentel.pdf");
      });
    });

    // Filtro visual del historial
    document.getElementById("filtroCompras").addEventListener("input", (e) => {
      const filtro = e.target.value.toLowerCase();
      document.querySelectorAll("#compra-list .mdl-list__item").forEach((item) => {
        item.style.display = item.textContent.toLowerCase().includes(filtro) ? "block" : "none";
      });
    });

    // Historial en vivo
    const contHistorial = document.getElementById("compra-list");
    onValue(ref(db, "compras_pimentel"), (snapshot) => {
      contHistorial.innerHTML = "";
      const data = snapshot.val();
      if (!data) return;

      Object.entries(data).forEach(([id, compra]) => {
        const item = document.createElement("div");
        item.className = "mdl-list__item mdl-list__item--three-line";
        item.innerHTML = `
          <span class="mdl-list__item-primary-content">
            <i class="zmdi zmdi-truck mdl-list__item-avatar"></i>
            <span><strong>${compra.codigoProducto}</strong> – ${compra.proveedor}</span>
            <span class="mdl-list__item-sub-title">${compra.fecha} | Factura: ${compra.factura || "-"} | Q${compra.total}</span>
          </span>
          <span class="mdl-list__item-secondary-action">
            <button class="mdl-button mdl-js-button mdl-button--icon" onclick="editarCompra('${id}')">
              <i class="zmdi zmdi-edit"></i>
            </button>
            <button class="mdl-button mdl-js-button mdl-button--icon" onclick="eliminarCompra('${id}')">
              <i class="zmdi zmdi-delete"></i>
            </button>
          </span>
        `;
        contHistorial.appendChild(item);
      });
    });

    // Editar compra
    window.editarCompra = function (id) {
      compraEditando = id;
      get(ref(db, "compras_pimentel/" + id)).then((snapshot) => {
        const compra = snapshot.val();
        if (!compra) return;

        document.getElementById("compraProveedor").value = compra.proveedor || "";
        document.getElementById("productQty").value = compra.cantidad || "";
        document.getElementById("compraPrecio").value = compra.precioUnitario || "";
        document.getElementById("compraFactura").value = compra.factura || "";

        const select = document.getElementById("compraProducto");
        select.value = compra.codigoProducto || "";
        const contSelect = select.closest(".mdl-textfield");
        if (contSelect) contSelect.classList.add("is-dirty");

        // Abrir pestaña y “levantar” labels
        document.querySelector('[href="#tabNewCompra"]').click();
        ["compraProveedor", "productQty", "compraPrecio", "compraFactura"].forEach((idEl) => {
          const el = document.getElementById(idEl);
          const wrap = el?.closest(".mdl-textfield");
          if (wrap) wrap.classList.add("is-dirty");
        });
      });
    };

    // Eliminar compra (sin revertir stock; si lo deseas, puedo activarlo)
    window.eliminarCompra = function (id) {
      Swal.fire({
        title: "¿Eliminar compra?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, eliminar"
      }).then((result) => {
        if (!result.isConfirmed) return;

        get(ref(db, "compras_pimentel/" + id)).then((snapshot) => {
          const compra = snapshot.val();
          if (!compra) return;

          set(ref(db, "compras_pimentel/" + id), null).then(() => {
            registrarAccion("eliminó una compra", "compras_pimentel", {
              proveedor: compra.proveedor,
              producto: compra.codigoProducto,
              cantidad: compra.cantidad,
              precioUnitario: compra.precioUnitario,
              total: compra.total,
              factura: compra.factura || "-",
              fecha: compra.fecha
            });
            Swal.fire("Eliminado", "Compra eliminada correctamente", "success");
          });
        });
      });
    };

    // Logout
    function logout() {
      signOut(auth)
        .then(() => {
          window.location.href = "opciones.html";
        })
        .catch((error) => {
          console.error("Error al cerrar sesión:", error);
          Swal.fire({ icon: "error", title: "Oops...", text: "No se pudo cerrar la sesión. Intenta de nuevo." });
        });
    }
    window.logout = logout;
  </script>
</body>
</html>
