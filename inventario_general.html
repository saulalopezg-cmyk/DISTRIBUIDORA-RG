<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario Consolidado</title>

  <!--  Firebase & SheetJS -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <!--  Estilos tipo inven -->
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/main.css" />
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>

  <!--  Barra superior -->
  <div class="full-width navBar">
    <div class="full-width navBar-options">
      <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>
      <nav class="navBar-options-list">
        <ul class="list-unstyle">
          <li class="btn-exit" onclick="logout()">
            <i class="zmdi zmdi-power"></i>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!--  Men煤 lateral -->
  <section class="full-width navLateral">
    <div class="full-width navLateral-bg btn-menu"></div>
    <div class="full-width navLateral-body">
      <div class="full-width navLateral-body-logo text-center tittles">
        <i class="zmdi zmdi-close btn-menu"></i> INVENTARIO GENERAL
      </div>
      <!-- Puedes agregar aqu铆 el men煤 lateral si lo necesitas -->
    </div>
  </section>

  <!--  Contenido principal -->
  <section class="full-width pageContent" style="text-align: center; padding: 60px 20px;">
    <h3 class="tittles">Inventario Consolidado</h3>
    <p>Haz clic en el bot贸n para descargar el inventario general.</p>
    <button id="btn-generar-xls" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
      <i class="zmdi zmdi-file-text"></i> Generar Excel
    </button>
  </section>

  <!--  L贸gica JS -->
  <script>
    
    const firebaseConfig = {
      apiKey: "AIzaSyB3V7b4lnqv8gTZa-HnczZhghSlYr1jHjE",
      authDomain: "distribuidorarg-9951a.firebaseapp.com",
      databaseURL: "https://distribuidorarg-9951a-default-rtdb.firebaseio.com",
      projectId: "distribuidorarg-9951a",
      storageBucket: "distribuidorarg-9951a.appspot.com",
      messagingSenderId: "785071843932",
      appId: "1:785071843932:web:59832bb2161f30ed665499"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    async function obtenerInventarios(db) {
      const bodegas = ["pimentel", "naranjo", "nixkab", "zona2", "zona7"];
      const datos = [];

      for (const nombre of bodegas) {
        const snapshot = await db.ref(`productos_${nombre}`).once("value");
        const inventario = snapshot.val() || {};
        const productos = Object.entries(inventario).map(([id, data]) => ({
          producto: data.nombre,
          cantidad: parseFloat(data.cantidad) || 0
        }));
        datos.push({ nombre, inventario: productos });
      }

      return datos;
    }

    function consolidarInventario(bodegas) {
      const mapa = new Map();

      bodegas.forEach(({ nombre, inventario }) => {
        inventario.forEach(({ producto, cantidad }) => {
          if (!mapa.has(producto)) {
            mapa.set(producto, { producto, total: 0 });
          }
          const registro = mapa.get(producto);
          registro[nombre.toUpperCase()] = cantidad;
          registro.total += cantidad;
        });
      });

      return Array.from(mapa.values());
    }

    function exportarInventarioConsolidado(data) {
      const fecha = new Date().toLocaleDateString("es-GT");
      const encabezado = [`INVENTARIO - FECHA ${fecha}`];
      const columnas = ["PRODUCTO", "PIMENTEL", "NARANJO", "NIXKAB", "ZONA2", "ZONA7", "TOTAL"];

      const filas = data.map(p => [
        p.producto,
        p.PIMENTEL || 0,
        p.NARANJO || 0,
        p.NIXKAB || 0,
        p.ZONA2 || 0,
        p.ZONA7 || 0,
        p.total
      ]);

      const hoja = XLSX.utils.aoa_to_sheet([encabezado, [], columnas, ...filas]);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Inventario Consolidado");
      XLSX.writeFile(libro, "inventario_general.xlsx");
    }

    document.getElementById("btn-generar-xls").addEventListener("click", async () => {
      try {
        const bodegas = await obtenerInventarios(db);
        const consolidado = consolidarInventario(bodegas);
        exportarInventarioConsolidado(consolidado);
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'No se pudo generar el archivo: ' + error.message
        });
      }
    });

    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "opciones.html";
      }).catch((error) => {
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'No se pudo cerrar la sesi贸n. Intenta de nuevo.'
        });
      });
    }

function logout() {
  const auth = firebase.auth();

  auth.signOut()
    .then(() => {
      Swal.fire({
        icon: 'success',
        title: 'Sesi贸n cerrada',
        text: 'Has salido correctamente.',
        confirmButtonText: 'OK'
      }).then(() => {
        window.location.href = "opciones.html"; // Redirige a tu p谩gina de inicio
      });
    })
    .catch((error) => {
      Swal.fire({
        icon: 'error',
        title: 'Error al cerrar sesi贸n',
        text: error.message
      });
    });
}

  </script>
</body>
</html>