<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generar XLS – RG NARANJO</title>
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/main.css" />
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <!-- Barra superior -->
  <div class="full-width navBar">
    <div class="full-width navBar-options">
      <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>
      <nav class="navBar-options-list">
        <ul class="list-unstyle">
          <li class="btn-exit" onclick="logout()">
            <i class="zmdi zmdi-power"></i>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Lateral -->
  <section class="full-width navLateral">
    <div class="full-width navLateral-bg btn-menu"></div>
    <div class="full-width navLateral-body">
      <div class="full-width navLateral-body-logo text-center tittles">
        <i class="zmdi zmdi-close btn-menu"></i> DISTRIBUIDORA RG - NARANJO
      </div>
      <figure class="full-width" style="height: 77px;">
        <div class="navLateral-body-cl">
          <img src="assets/img/logo_rg.png" />
        </div>
        <figcaption class="navLateral-body-cr hide-on-tablet">
          <span><br /><small></small></span>
        </figcaption>
      </figure>
      <div class="full-width tittles navLateral-body-tittle-menu">
        <i class="zmdi zmdi-desktop-mac"></i><span class="hide-on-tablet"> MENÚ</span>
      </div>
      <nav class="full-width">
        <ul class="full-width list-unstyle menu-principal">
          <li><a href="inventario_naranjo.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-store"></i></div><div class="navLateral-body-cr hide-on-tablet">Inventario</div></a></li>
          <li><a href="cliente_naranjo.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-accounts"></i></div><div class="navLateral-body-cr hide-on-tablet">Clientes</div></a></li>
          <li><a href="compras_naranjo.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-basket"></i></div><div class="navLateral-body-cr hide-on-tablet">Compras</div></a></li>
          <li><a href="proveedores_naranjo.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-truck"></i></div><div class="navLateral-body-cr hide-on-tablet">Proveedores</div></a></li>
          <li><a href="ventas_naranjo.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div><div class="navLateral-body-cr hide-on-tablet">Ventas</div></a></li>
          <li><a href="cuentas-cobrar_naranjo.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-balance-wallet"></i></div><div class="navLateral-body-cr hide-on-tablet">Cuentas por cobrar</div></a></li>
          <li><a href="generar_xls_naranjo.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-file"></i></div><div class="navLateral-body-cr hide-on-tablet">Generar XLS</div></a></li>
        </ul>
      </nav>
    </div>
  </section>

  <!-- Contenido -->
  <section class="full-width pageContent" style="text-align: center; padding: 60px 20px;">
    <h3 class="tittles">Generar archivo XLS consolidado</h3>
    <p>Haz clic en el botón para descargar todos los datos en un solo Excel.</p>
    <button id="btn-generar-xls" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
      <i class="zmdi zmdi-file-text"></i> Generar XLS
    </button>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3V7b4lnqv8gTZa-HnczZhghSlYr1jHjE",
      authDomain: "distribuidorarg-9951a.firebaseapp.com",
      databaseURL: "https://distribuidorarg-9951a-default-rtdb.firebaseio.com",
      projectId: "distribuidorarg-9951a",
      storageBucket: "distribuidorarg-9951a.appspot.com",
      messagingSenderId: "785071843932",
      appId: "1:785071843932:web:59832bb2161f30ed665499"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    function toNum(n) {
      const v = Number(n);
      return Number.isFinite(v) ? v : 0;
    }

    document.getElementById("btn-generar-xls").addEventListener("click", () => {
      Promise.all([
        get(ref(db, "productos_naranjo")),
        get(ref(db, "clientes_naranjo")),
        get(ref(db, "compras_naranjo")),
        get(ref(db, "proveedores_naranjo"))
      ]).then(([snapProductos, snapClientes, snapCompras, snapProveedores]) => {
        const productos = snapProductos.val() || {};
        const clientes = snapClientes.val() || {};
        const compras = snapCompras.val() || {};
        const proveedores = snapProveedores.val() || {}; // ✅ corregido

        // ----- Hoja: Inventario (con Presentación) -----
        const datosProductos = [["Código", "Nombre", "Cantidad", "Presentación", "Precio", "Proveedor"]];
        Object.values(productos).forEach(p => {
          datosProductos.push([
            p.codigo || "-",
            p.nombre || "-",
            toNum(p.cantidad),
            p.presentacion || "-",          // ✅ nueva columna
            toNum(p.precio),
            p.proveedor || "-"
          ]);
        });

        // ----- Hoja: Clientes -----
        const datosClientes = [["Nombre", "Correo", "Tipo"]];
        Object.values(clientes).forEach(c => {
          datosClientes.push([c.nombre || "-", c.correo || "-", c.tipo || "-"]);
        });

        // ----- Hoja: Compras -----
        const datosCompras = [["Factura", "Proveedor", "Producto/Código", "Fecha", "Cantidad", "Precio Unitario", "Total"]];
        Object.values(compras).forEach(c => {
          datosCompras.push([
            c.factura || "-",
            c.proveedor || "-",
            c.codigoProducto || "-",
            c.fecha || "-",
            toNum(c.cantidad),
            toNum(c.precioUnitario),
            toNum(c.total)
          ]);
        });

        // ----- Hoja: Proveedores (columnas separadas) -----
        const datosProveedores = [["Nombre", "NIT", "Contacto", "Teléfono", "Dirección"]];
        Object.values(proveedores).forEach(pv => {
          datosProveedores.push([
            pv.nombre || "-",
            pv.nit || "-",
            pv.contacto || "-",
            pv.telefono || "-",
            pv.direccion || "-"
          ]);
        });

        // Crear libro y hojas
        const libro = XLSX.utils.book_new();

        const wsProd = XLSX.utils.aoa_to_sheet(datosProductos);
        const wsCli  = XLSX.utils.aoa_to_sheet(datosClientes);
        const wsComp = XLSX.utils.aoa_to_sheet(datosCompras);
        const wsProv = XLSX.utils.aoa_to_sheet(datosProveedores);

        // (Opcional) Anchos de columnas para que se vea mejor
        wsProd['!cols'] = [
          { wch: 12 }, // Código
          { wch: 32 }, // Nombre
          { wch: 12 }, // Cantidad
          { wch: 14 }, // Presentación
          { wch: 12 }, // Precio
          { wch: 24 }  // Proveedor
        ];
        wsCli['!cols'] = [{ wch: 28 }, { wch: 30 }, { wch: 14 }];
        wsComp['!cols'] = [{ wch: 14 }, { wch: 24 }, { wch: 20 }, { wch: 12 }, { wch: 10 }, { wch: 14 }, { wch: 12 }];
        wsProv['!cols'] = [{ wch: 24 }, { wch: 16 }, { wch: 20 }, { wch: 14 }, { wch: 28 }];

        XLSX.utils.book_append_sheet(libro, wsProd, "Inventario");
        XLSX.utils.book_append_sheet(libro, wsCli, "Clientes");
        XLSX.utils.book_append_sheet(libro, wsComp, "Compras");
        XLSX.utils.book_append_sheet(libro, wsProv, "Proveedores");

        XLSX.writeFile(libro, "reporte_rg_naranjo.xlsx");
      }).catch((err) => {
        console.error(err);
        Swal.fire("Error", "No se pudo generar el archivo", "error");
      });
    });

    // Logout
    function logout() {
      signOut(auth)
        .then(() => {
          window.location.href = "opciones.html";
        })
        .catch((error) => {
          console.error("Error al cerrar sesión:", error);
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'No se pudo cerrar la sesión. Intenta de nuevo.'
          });
        });
    }
    // Exponer global
    window.logout = logout;
  </script>
</body>
</html>
